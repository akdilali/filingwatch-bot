name: FilingWatch Bot (Daily)

on:
  schedule:
    # Run every 6 hours (06:00, 12:00, 18:00, 00:00 UTC)
    # Note: GitHub Actions uses UTC.
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Important for committing changes

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run FilingWatch Bot
      env:
        X_API_KEY: ${{ secrets.X_API_KEY }}
        X_API_SECRET: ${{ secrets.X_API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      run: |
        # Ensure script is executable
        chmod +x run_bot.sh
        # Run the bot
        ./run_bot.sh

    - name: Run Tech News (Techmeme - 18:00 UTC ~ 21:00 TRT)
      if: github.event.schedule == '0 18 * * *' || github.event_name == 'workflow_dispatch'
      env:
        X_API_KEY: ${{ secrets.X_API_KEY }}
        X_API_SECRET: ${{ secrets.X_API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      run: |
        python tech_news.py techmeme

    - name: Run Tech News (Product Hunt - 06:00 UTC ~ 09:00 TRT)
      if: github.event.schedule == '0 6 * * *' || github.event_name == 'workflow_dispatch'
      env:
        X_API_KEY: ${{ secrets.X_API_KEY }}
        X_API_SECRET: ${{ secrets.X_API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      run: |
        python tech_news.py producthunt

    - name: Run Weekly Stats (Monday Only - 12:00 UTC ~ 07:00 AM EST)
      if: github.event.schedule == '0 12 * * *' || github.event_name == 'workflow_dispatch'
      env:
        X_API_KEY: ${{ secrets.X_API_KEY }}
        X_API_SECRET: ${{ secrets.X_API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      run: |
        # Check if today is Monday (1)
        if [ $(date +%u) -eq 1 ]; then
          echo "It is Monday, creating report..."
          python main_v2.py stats-weekly --tweet
        else
          echo "Not Monday. Skipping report."
        fi

    - name: Run Tech News (GitHub Check - 12:00 UTC ~ 15:00 TRT)
      if: github.event.schedule == '0 12 * * *' || github.event_name == 'workflow_dispatch'
      env:
        X_API_KEY: ${{ secrets.X_API_KEY }}
        X_API_SECRET: ${{ secrets.X_API_SECRET }}
        X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
      run: |
        python tech_news.py github

    - name: Commit and Push changes (Persistence)
      run: |
        git config --global user.name 'FilingWatch Bot'
        git config --global user.email 'bot@filingwatch.com'
        
        # Add state files
        git add scraper_state.json posted_tweets.json daily_cache.json history.json bot_scheduler.log
        
        # Check if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto: Update bot state & logs [skip ci]"
          git push
        fi
